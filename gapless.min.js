var GaplessPlaybackState;!function(t){t[t.Stopped=0]="Stopped",t[t.Buffering=1]="Buffering",t[t.Playing=2]="Playing",t[t.ReadyToSwitchToWebAudio=3]="ReadyToSwitchToWebAudio",t[t.Paused=4]="Paused"}(GaplessPlaybackState||(GaplessPlaybackState={}));var GaplessPlayback=function(){function t(){this.context="webkitAudioContext"in window?new window.webkitAudioContext:new AudioContext,this.gainNode=this.context.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.context.destination)}return t.prototype.buildTrackForUrl=function(t){var e=this,r=new GaplessTrack(this.context,this.gainNode,t);return r.onPrepareNextTrack=function(){e.onNeedsNextUrl(function(t){null!=t&&(e.nextTrack=e.buildTrackForUrl(t),e.nextTrack.load())})},r.onEnded=function(){var t=e.currentTrack.url;e.nextTrack?(e.nextTrack.play(),e.currentTrack=e.nextTrack,e.onStarted(e.currentTrack.url),e.nextTrack=null):e.currentTrack=null,e.onEnded(t,null!=e.currentTrack)},r},t.prototype.stateToString=function(t){return t==GaplessPlaybackState.Buffering?"buffering":t==GaplessPlaybackState.Paused?"paused":t==GaplessPlaybackState.Playing?"playing":t==GaplessPlaybackState.ReadyToSwitchToWebAudio?"ready to switch to web audio":t==GaplessPlaybackState.Stopped?"stopped":"unknown state"},t.prototype.startUpdates=function(){var t=this;setInterval(function(){t.currentTrack&&t.onPlaybackUpdate({stateDescription:t.stateToString(t.currentTrack.state),state:t.currentTrack.state,url:t.currentTrack.url,duration:t.currentTrack.duration(),elapsed:t.currentTrack.elapsed()})},3e3)},t.prototype.setCurrentTrack=function(t){null!=t&&(this.currentTrack=this.buildTrackForUrl(t))},t.prototype.load=function(t){var e=this;t?(this.setCurrentTrack(t),this.currentTrack.load()):null==this.currentTrack?this.onNeedsNextUrl(function(t){e.setCurrentTrack(t),e.currentTrack.load()}):this.currentTrack.load()},t.prototype.play=function(t){t?(this.startUpdates(),this.setCurrentTrack(t),this.currentTrack.play(),this.onStarted(this.currentTrack.url)):this.currentTrack&&(this.startUpdates(),this.currentTrack.play(),this.onStarted(this.currentTrack.url))},t.prototype.pause=function(){this.currentTrack&&this.currentTrack.pause()},t.prototype.next=function(){this.nextTrack&&(this.currentTrack.pause(),this.nextTrack.play(),this.currentTrack=this.nextTrack,this.nextTrack=null)},t.prototype.duration=function(){return this.currentTrack?this.currentTrack.duration():-1},t.prototype.elapsed=function(){return this.currentTrack?this.currentTrack.elapsed():-1},t.prototype.seekToPercent=function(t){return this.currentTrack?this.currentTrack.seekToPercent(t):void 0},t.prototype.seekToTime=function(t){return this.currentTrack?this.currentTrack.seekToTime(t):void 0},t}(),GaplessTrackSource;!function(t){t[t.HTMLAudioElement=0]="HTMLAudioElement",t[t.WebAudio=1]="WebAudio"}(GaplessTrackSource||(GaplessTrackSource={}));var GaplessTrack=function(){function t(t,e,r){this.bufferStartTime=0,this.bufferStartOffset=0,this.bufferStartOffsetFromHTMLAudio=0,this.onPrepareNextTrack=null,this.onEnded=null,this.hasAttemptedLoad=!1,this.context=t,this.gainNode=e,this.audio=new Audio,this.audio.src=r,this.audio.controls=!1,this.audio.preload="auto",this.audio.volume=1,this.audio.onerror=function(t){console.log(t)},this.url=r,this.state=GaplessPlaybackState.Stopped,this.source=GaplessTrackSource.HTMLAudioElement}return t.prototype.getAudio=function(){return this.audio},t.prototype.clearAudio=function(){this.audio=null},t.prototype.setFullBuffer=function(t){this.buf=t},t.prototype.getFullBuffer=function(){return this.buf},t.prototype.loadBuffer=function(t,e){var r=new XMLHttpRequest;r.open("get",this.url,!0),r.responseType="arraybuffer",r.onload=function(){t.decodeAudioData(r.response,function(t){e(t)})},r.send()},t.prototype.makeNewSourceNode=function(){var t=this,e=this.context.createBufferSource();return e.buffer=this.getFullBuffer(),e.connect(this.gainNode),e.onended=function(){null!=t.onEnded&&t.onEnded()},e},t.prototype.switchToWebAudio=function(){this.debug("switching to web audio..."),this.currentSourceNode=this.makeNewSourceNode(),console.log("context: %f, audio: %f",this.context.currentTime,this.getAudio().currentTime),this.bufferStartTime=this.context.currentTime,this.bufferStartOffsetFromHTMLAudio=this.getAudio().currentTime,this.currentSourceNode.start(0,this.getAudio().currentTime),this.getAudio().pause(),this.clearAudio(),this.source=GaplessTrackSource.WebAudio,this.debug("...done. Did you hear a blip!?"),this.state=GaplessPlaybackState.Playing,null!=this.onPrepareNextTrack&&this.onPrepareNextTrack()},t.prototype.attemptSwitchToWebAudio=function(){this.debug("attempting to switch to web audio..."),console.log(this.getAudio()),console.log(this.getAudio().played),null!=this.getAudio()&&this.getAudio().played.length>0&&this.switchToWebAudio()},t.prototype.debug=function(t){console.log(this.url+": "+t)},t.prototype.load=function(){var t=this;this.hasAttemptedLoad||(this.hasAttemptedLoad=!0,this.debug("loading HTML5 audio..."),this.audio.load(),this.state=GaplessPlaybackState.Buffering,this.audio.addEventListener("playing",function(e){t.state!=GaplessPlaybackState.ReadyToSwitchToWebAudio&&(t.state=GaplessPlaybackState.Playing)}),this.audio.addEventListener("canplay",function(e){t.debug("can play HTML5 audio"),t.state=GaplessPlaybackState.Paused}),this.audio.addEventListener("canplaythrough",function(e){t.debug("HTML5 audio fully loaded"),t.loadBuffer(t.context,function(e){t.state=GaplessPlaybackState.ReadyToSwitchToWebAudio,t.debug("audio parsed"),t.setFullBuffer(e),t.attemptSwitchToWebAudio()})}),this.audio.addEventListener("ended",function(e){null!=t.onEnded&&t.onEnded()}))},t.prototype.duration=function(){return this.source==GaplessTrackSource.HTMLAudioElement?this.getAudio().duration:this.getFullBuffer().duration},t.prototype.play=function(){var t=this;return this.state==GaplessPlaybackState.ReadyToSwitchToWebAudio?(this.debug("play requested with full web audio buffer. playing html5 first"),this.getAudio().play(),this.state=GaplessPlaybackState.Playing,void setTimeout(function(){t.attemptSwitchToWebAudio()},500)):(this.load(),this.source==GaplessTrackSource.HTMLAudioElement?this.getAudio().play():this.state==GaplessPlaybackState.Paused?(this.bufferStartTime=this.context.currentTime,this.bufferStartOffsetFromHTMLAudio=this.bufferStartOffset+this.bufferStartOffsetFromHTMLAudio,this.seekToTime(this.bufferStartOffset)):this.debug("huh? tried playing web audio before html5 audio because it never got to a paused state"),void(this.state=GaplessPlaybackState.Playing))},t.prototype.pause=function(){this.source==GaplessTrackSource.HTMLAudioElement?this.getAudio().pause():(this.bufferStartOffset+=this.context.currentTime-this.bufferStartTime,this.currentSourceNode.onended=null,this.currentSourceNode.stop(0)),this.state=GaplessPlaybackState.Paused},t.prototype.seekToPercent=function(t){this.seekToTime(t*this.duration())},t.prototype.seekToTime=function(t){if(this.source==GaplessTrackSource.HTMLAudioElement)this.getAudio().currentTime=t;else{var e=this.currentSourceNode;this.currentSourceNode=this.makeNewSourceNode(),this.bufferStartTime=this.context.currentTime,this.bufferStartOffsetFromHTMLAudio=t,this.currentSourceNode.start(0,t),e.onended=null,e.stop()}},t.prototype.elapsed=function(){return this.source==GaplessTrackSource.HTMLAudioElement?this.getAudio().currentTime:this.state==GaplessPlaybackState.Playing?this.context.currentTime-this.bufferStartTime+this.bufferStartOffsetFromHTMLAudio:this.bufferStartOffset+this.bufferStartOffsetFromHTMLAudio},t.prototype.getState=function(){return this.state},t}();
//# sourceMappingURL=gapless.min.js